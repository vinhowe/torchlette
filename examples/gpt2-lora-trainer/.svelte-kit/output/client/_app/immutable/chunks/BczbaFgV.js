import{n as y}from"./CNEoBiV9.js";const z={relu:(e,t="0.0")=>`select(${t}, ${e}, ${e} > ${t})`,gelu:e=>`(${e} * 0.5 * (1.0 + tanh(clamp(0.7978845608 * (${e} + 0.044715 * ${e} * ${e} * ${e}), -10.0, 10.0))))`,gelu_tanh:e=>`(${e} * 0.5 * (1.0 + tanh(clamp(0.7978845608 * (${e} + 0.044715 * ${e} * ${e} * ${e}), -10.0, 10.0))))`,gelu_erf:e=>`(${e} * 0.5 * (1.0 + sign(${e}) * (1.0 - (((((1.061405429 * (1.0 / (1.0 + 0.3275911 * abs(${e} * 0.7071067811865476))) + -1.453152027) * (1.0 / (1.0 + 0.3275911 * abs(${e} * 0.7071067811865476))) + 1.421413741) * (1.0 / (1.0 + 0.3275911 * abs(${e} * 0.7071067811865476))) + -0.284496736) * (1.0 / (1.0 + 0.3275911 * abs(${e} * 0.7071067811865476))) + 0.254829592) * (1.0 / (1.0 + 0.3275911 * abs(${e} * 0.7071067811865476))) * exp(-${e} * ${e} * 0.5)))))`,silu:e=>`(${e} / (1.0 + exp(-${e})))`,sigmoid:e=>`(1.0 / (1.0 + exp(-${e})))`,tanh:e=>`tanh(${e})`,softplus:e=>`log(1.0 + exp(${e}))`,neg:e=>`(-${e})`,abs:e=>`abs(${e})`,exp:e=>`exp(${e})`,log:e=>`log(${e})`,sqrt:e=>`sqrt(${e})`,rsqrt:e=>`inverseSqrt(${e})`,sin:e=>`sin(${e})`,cos:e=>`cos(${e})`,floor:e=>`floor(${e})`,ceil:e=>`ceil(${e})`,round:e=>`round(${e})`,sign:e=>`sign(${e})`,cast_f16:e=>`f16(${e})`,cast_f32:e=>`f32(${e})`,cast_i32:e=>`i32(${e})`,cast_u32:e=>`u32(${e})`},O={add:(e,t)=>`(${e} + ${t})`,sub:(e,t)=>`(${e} - ${t})`,mul:(e,t)=>`(${e} * ${t})`,div:(e,t)=>`(${e} / ${t})`,pow:(e,t)=>`pow(${e}, ${t})`,min:(e,t)=>`min(${e}, ${t})`,max:(e,t)=>`max(${e}, ${t})`,mod:(e,t)=>`(${e} % ${t})`,eq:(e,t)=>`select(0.0, 1.0, ${e} == ${t})`,ne:(e,t)=>`select(0.0, 1.0, ${e} != ${t})`,lt:(e,t)=>`select(0.0, 1.0, ${e} < ${t})`,le:(e,t)=>`select(0.0, 1.0, ${e} <= ${t})`,gt:(e,t)=>`select(0.0, 1.0, ${e} > ${t})`,ge:(e,t)=>`select(0.0, 1.0, ${e} >= ${t})`};function B(e,t){if(t!=="f32"&&t!=="f16"||e.length===0)return 1;let i=e[e.length-1];return e.reduce((n,u)=>n*u,1)<16?1:i>=4&&i%4==0?4:i>=2&&i%2==0?2:1}function D(e,t,i){if(i===1)return!0;if(e.length===0)return!1;let n=e[e.length-1];if(n%i!==0)return!1;for(let u of t){if(u.shape.reduce((l,c)=>l*c,1)===1)continue;if(u.shape.length===0)return!1;let p=u.shape[u.shape.length-1];if(p!==n&&p!==1||p===n&&p%i!==0)return!1}return!0}function j(e,t){return t===1?w(e):`vec${t}<${w(e)}>`}function I(e,t,i,n){if(e.length===t.length&&e.every((r,$)=>r===t[$]))return`let ${n} = ${i};`;if(t.reduce((r,$)=>r*$,1)===1)return`let ${n} = 0u;`;let u=[],p=e.length,l=t.length,c=p-l;u.push(`var _tmp_${n} = ${i};`);let a=[];for(let r=p-1;r>=0;r--){let $=`_c${r}_${n}`,d=e[r];u.push(`let ${$} = _tmp_${n} % ${d}u;`),u.push(`_tmp_${n} = _tmp_${n} / ${d}u;`),a.unshift($)}let s=[];for(let r=0;r<l;r++){let $=r+c,d=t[r],v=a[$];d===1?s.push("0u"):s.push(v)}let h=s[0];for(let r=1;r<l;r++)t.slice(r+1).reduce(($,d)=>$*d,1),h=`(${h} * ${t[r]}u + ${s[r]})`;return l===1&&(h=s[0]),u.push(`let ${n} = ${h};`),u.join(`
  `)}function C(e,t){return e.length===t.length?!e.every((i,n)=>i===t[n]):!0}function R(e,t=1){let i=new Map,n=[],u=t===1?"0.0":`vec${t}<f32>(0.0)`,p=t===1?"1.0":`vec${t}<f32>(1.0)`,l=new Map;for(let a of e.nodes)for(let s of a.inputs)l.set(s,(l.get(s)??0)+1);for(let a=0;a<e.nodes.length;a++){let s=e.nodes[a],h=`t${s.id}`,r=[];for(let m of s.inputs)if(m<0){let x=-m-1;r.push(`v${x}`)}else{let x=i.get(m);if(!x)throw Error(`Missing variable for node ${m}`);r.push(x)}let $;if(s.op in z)$=z[s.op](r[0],u,p);else if(s.op in O)$=O[s.op](r[0],r[1]);else if(s.op.startsWith("cast_")&&s.op in z)$=z[s.op](r[0],u,p);else throw Error(`Unknown fusible op: ${s.op}`);let d=s.isOutput??a===e.nodes.length-1,v=(l.get(s.id)??0)>1;d||v?(n.push(`let ${h} = ${$};`),i.set(s.id,h)):i.set(s.id,`(${$})`)}let c=e.nodes[e.nodes.length-1];return{lines:n,varNames:i,outputVar:i.get(c.id)??`t${c.id}`}}function F(e,t={}){let i=t.workgroupSize??e.workgroupSize??256,n=e.outputs[0].shape,u=e.outputs[0].dtype,p=n.reduce((o,g)=>o*g,1),l=1;if(t.forceVectorWidth!==void 0)l=t.forceVectorWidth;else if(t.vectorize){let o=B(n,u);D(n,e.inputs,o)&&(l=o)}let c=Math.ceil(p/l),a=l>1,s=a?j(u,l):w(u),h=[];for(let o=0;o<e.inputs.length;o++){let g=e.inputs[o],b=w(g.dtype);h.push(`@group(0) @binding(${o}) var<storage, read> in${o}: array<${b}>;`)}let r=[];for(let o=0;o<e.outputs.length;o++){let g=e.outputs[o],b=e.inputs.length+o,S=w(g.dtype);r.push(`@group(0) @binding(${b}) var<storage, read_write> out${o}: array<${S}>;`)}let $=[];for(let o=0;o<e.inputs.length;o++){let g=e.inputs[o],b=g.shape.reduce((S,q)=>S*q,1)===1;a?b?$.push(`let v${o} = ${s}(in${o}[0]);`):C(n,g.shape)?$.push(W(n,g.shape,o,l,u)):$.push(T(o,l,u)):C(n,g.shape)?($.push(I(n,g.shape,"idx",`idx${o}`)),$.push(`let v${o} = in${o}[idx${o}];`)):$.push(`let v${o} = in${o}[idx];`)}let{lines:d,varNames:v}=R(e,l),m=[];for(let o=0;o<e.outputs.length;o++){let g=e.outputs[o],b=v.get(g.nodeId)??`t${g.nodeId}`;a?m.push(...G(b,o,l)):m.push(`out${o}[idx] = ${b};`)}let x=m.join(`
  `),f=a?`gid.x * ${l}u`:"gid.x",_=a?`if (gid.x * ${l}u >= params.total_elements) { return; }`:"if (gid.x >= params.total_elements) { return; }",P=e.inputs.length+e.outputs.length,A=`
// Fused elementwise kernel: ${e.id}
// Ops: ${e.nodes.map(o=>o.op).join(" -> ")}
// Outputs: ${e.outputs.length}
// Vectorization: ${a?`vec${l}`:"scalar"}

${h.join(`
`)}
${r.join(`
`)}

struct Params {
  total_elements: u32,
}
@group(0) @binding(${P}) var<uniform> params: Params;

@compute @workgroup_size(${i})
fn main(@builtin(global_invocation_id) gid: vec3<u32>) {
  ${_}
  let idx = ${f};

  // Load inputs${a?" (vectorized)":""}
  ${$.join(`
  `)}

  // Fused computation
  ${d.join(`
  `)}

  // Store outputs${a?" (vectorized)":""}
  ${x}
}
`.trim(),E=N(e,l);return{source:A,workgroupSize:i,inputBindings:e.inputs.length,cacheKey:E,vectorWidth:l,workItems:c}}function G(e,t,i){let n=[];for(let u=0;u<i;u++){let p=i===2?["x","y"][u]:["x","y","z","w"][u];n.push(`out${t}[idx + ${u}u] = ${e}.${p};`)}return n}function T(e,t,i){let n=j(i,t),u=[];for(let p=0;p<t;p++)u.push(`in${e}[idx + ${p}u]`);return`let v${e} = ${n}(${u.join(", ")});`}function W(e,t,i,n,u){let p=j(u,n),l=[],c=[];for(let a=0;a<n;a++){let s=`idx + ${a}u`,h=`bc${i}_${a}`;l.push(K(e,t,s,h)),c.push(`in${i}[${h}]`)}return l.push(`let v${i} = ${p}(${c.join(", ")});`),l.join(`
  `)}function K(e,t,i,n){if(t.reduce((r,$)=>r*$,1)===1)return`let ${n} = 0u;`;let u=e.length,p=t.length,l=u-p,c=[];c.push(`var _t_${n} = ${i};`);let a=[];for(let r=u-1;r>=0;r--){let $=`_c${r}_${n}`,d=e[r];c.push(`let ${$} = _t_${n} % ${d}u;`),c.push(`_t_${n} = _t_${n} / ${d}u;`),a.unshift($)}let s=[];for(let r=0;r<p;r++){let $=r+l,d=t[r],v=a[$];s.push(d===1?"0u":v)}let h=s[0];for(let r=1;r<p;r++)h=`(${h} * ${t[r]}u + ${s[r]})`;return p===1&&(h=s[0]),c.push(`let ${n} = ${h};`),c.join(`
  `)}function w(e){switch(e){case"f32":return"f32";case"f16":return"f16";case"i32":return"i32";case"u32":return"u32";case"bool":return"u32";default:return"f32"}}function N(e,t=1){let i=[e.id,`vec:${t}`];for(let u of e.outputs)i.push(`out${u.index}:${u.shape.join("x")}:${u.dtype}`);for(let u of e.inputs)i.push(`in${u.index}:${u.shape.join("x")}:${u.dtype}`);let n=e.nodes.map(u=>`${u.op}:${u.id}`).join(",");return i.push(`ops:[${n}]`),i.join("|")}const k={COPY_SRC:4,COPY_DST:8,UNIFORM:64,STORAGE:128};var U=class{cache=new Map;maxSize;constructor(e=256){this.maxSize=e}getOrCreate(e,t,i={}){let n=F(t,i),u=this.cache.get(n.cacheKey);if(u)return{pipeline:u.pipeline,kernel:n};let p=e.createShaderModule({code:n.source}),l=e.createComputePipeline({layout:"auto",compute:{module:p,entryPoint:"main"}});if(this.cache.size>=this.maxSize){let c=null,a=1/0;for(let[s,h]of this.cache)h.createdAt<a&&(a=h.createdAt,c=s);c&&this.cache.delete(c)}return this.cache.set(n.cacheKey,{pipeline:l,kernel:n,createdAt:Date.now()}),{pipeline:l,kernel:n}}clear(){this.cache.clear()}stats(){return{size:this.cache.size,maxSize:this.maxSize}}};let M=null;function V(){return M||=new U,M}function H(e,t,i,n={}){let{pipeline:u,kernel:p}=(n.cache??V()).getOrCreate(e,t,{vectorize:n.vectorize??!0});if(i.length!==t.inputs.length)throw Error(`Expected ${t.inputs.length} inputs, got ${i.length}`);let l=t.outputs[0],c=l.shape.reduce((f,_)=>f*_,1),a=f=>{y.trackAllocation(null,f.size);try{let _=e.createBuffer(f);return y.trackDeallocation(null),y.trackAllocation(_,f.size),_}catch(_){throw y.trackDeallocation(null),_}},s=[],h=[];for(let f of t.outputs){let _=a({size:c*Y(f.dtype),usage:k.STORAGE|k.COPY_SRC});s.push(_),h.push({buffer:_,shape:f.shape.slice(),dtype:f.dtype})}let r=a({size:4,usage:k.UNIFORM|k.COPY_DST});e.queue.writeBuffer(r,0,new Uint32Array([c]));let $=[];for(let f=0;f<i.length;f++)$.push({binding:f,resource:{buffer:i[f].buffer}});for(let f=0;f<s.length;f++)$.push({binding:i.length+f,resource:{buffer:s[f]}});$.push({binding:i.length+t.outputs.length,resource:{buffer:r}});let d=e.createBindGroup({layout:u.getBindGroupLayout(0),entries:$}),v=e.createCommandEncoder(),m=v.beginComputePass();m.setPipeline(u),m.setBindGroup(0,d);let x=Math.ceil(p.workItems/p.workgroupSize);return m.dispatchWorkgroups(x),m.end(),e.queue.submit([v.finish()]),{outputs:h,buffer:s[0],shape:l.shape.slice(),dtype:l.dtype}}function Y(e){switch(e){case"f32":case"i32":case"u32":return 4;case"f16":return 2;case"bool":return 1;default:return 4}}export{H as dispatchFusedKernel};
