# Docker Compose for Torchlette WebGPU tests + PyTorch oracle tests
#
# Usage:
#   # Build and run with software rendering (default)
#   docker compose up torchlette
#
#   # Build and run with NVIDIA GPU
#   docker compose up torchlette-gpu
#
#   # Run specific tests
#   docker compose run torchlette npm test -- test/checkpoint-scale-analysis.spec.ts
#
#   # Run oracle tests (PyTorch comparison)
#   docker compose run oracle-tests
#
#   # Interactive shell
#   docker compose run torchlette bash

services:
  # Software rendering (works on any machine, no GPU needed)
  torchlette:
    build: .
    environment:
      - TORCHLETTE_WEBGPU=1
      - LIBGL_ALWAYS_SOFTWARE=1
      - GALLIUM_DRIVER=llvmpipe
      - MESA_GL_VERSION_OVERRIDE=4.5
    volumes:
      # Mount test results for viewing
      - ./coverage:/app/coverage
    command: npm test

  # GPU-accelerated (requires nvidia-docker)
  torchlette-gpu:
    build: .
    environment:
      - TORCHLETTE_WEBGPU=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, compute, utility, graphics]
    volumes:
      - ./coverage:/app/coverage
    command: npm test
